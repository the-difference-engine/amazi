(function() {
  "use strict";

  angular.module("app").controller("mapCtrl", function($scope, $http, $q) {

    $scope.setUp = function() {
      function geoLocation() {
        var deferred = $q.defer();
        $scope.map = {};
        if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          $scope.mapCenter = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          $scope.map.setCenter($scope.mapCenter)
        }, function() {
            handleLocationError(true, $scope.map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, $scope.map.getCenter());
        }
        deferred.resolve();
        return deferred.promise;
      };
        geoLocation().then( function(response){
          initMap().then( function(map) {
            $scope.map = map;
            google.maps.event.addListener($scope.map, 'bounds_changed', function() {
            $scope.bounds = $scope.map.getBounds();
            getLocations($scope.bounds);
            });
          });
        });
    };


    function initMap() {
      var deferred = $q.defer();

      $scope.mapCenter = {
        lat: 39.7877,
        lng: -122.4048
      };
      var map = new google.maps.Map(document.getElementById('mapView'), {
        center: {lat: $scope.mapCenter.lat, lng: $scope.mapCenter.lng},
        zoom: 16,
      });
      deferred.resolve(map);
      return deferred.promise;
    };
    function getLocations(bounds) {
      var swLat  = bounds.getSouthWest().lat();
      var swLong = bounds.getSouthWest().lng();
      var neLat  = bounds.getNorthEast().lat();
      var neLong = bounds.getNorthEast().lng();
      $http.get('/api/v1/locations.json/?swLat=' + swLat + '&swLong=' + swLong + '&neLat=' + neLat + '&neLong=' + neLong).then(function(response) {
        $scope.locations = response.data;
        createMarkers($scope.locations);
      });
    };

    function createMarkers(locations) {
      var infowindow = new google.maps.InfoWindow();
      google.maps.event.addListener($scope.map, "click", function(event) {
        infowindow.close();
      });
      locations.forEach(function(location) {
        var marker = new google.maps.Marker({
          position: {lat: location.latitude, lng: location.longitude},
          map: $scope.map,
          title: location.address
        });
        marker.addListener('click', function() {
        var content = "<a href=/locations/" + location.id + '>' + location.address + "</a>";
        infowindow.setContent(content);
        infowindow.open($scope.map, marker);

        });
      });
    };

  });
})();

